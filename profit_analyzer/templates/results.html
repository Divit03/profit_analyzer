<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analysis Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:," type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            overflow-x: hidden;
        }
        .navbar {
            background-color: #f8f9fa !important;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .btn {
            border-radius: 25px;
            font-weight: 500;
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }
        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
        }
        .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        .timeline-item {
            background: #f8f9fa;
            padding: 10px;
            border-left: 3px solid #007bff;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .text-neon {
            color: #007bff;
            font-weight: bold;
        }
        .animate-fade-in {
            animation: fadeIn 1s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .finbot-sidebar {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            height: 400px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #dee2e6;
            border-radius: 10px 0 0 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            flex-direction: column;
        }
        .finbot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #007bff;
            color: white;
            border-radius: 10px 0 0 0;
        }
        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
        }
        .finbot-toggle {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            z-index: 1001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="{% if theme == 'dark' %}dark-theme{% else %}light-theme{% endif %}">
    <nav class="navbar navbar-expand-lg navbar-light shadow">
        <div class="container">
            <a class="navbar-brand text-dark" href="/"><i class="fas fa-home"></i> Home</a>
            <a class="btn btn-outline-info" href="/tips"><i class="fas fa-lightbulb"></i> Tips</a>
            <form action="/toggle_theme" method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-secondary"><i class="fas fa-moon"></i> Toggle Theme</button>
            </form>
        </div>
    </nav>
    
    <!-- FinBot Sidebar -->
    <div id="finbotSidebar" class="finbot-sidebar">
        <div class="finbot-header">
            <h6><i class="fas fa-robot"></i> FinBot</h6>
            <button class="btn btn-sm btn-close" onclick="toggleFinbot()"></button>
        </div>
        <div id="chatBox" class="chat-box"></div>
        <input type="text" id="chatInput" class="form-control mt-2" placeholder="Ask FinBot...">
        <button class="btn btn-primary btn-sm mt-2 w-100" onclick="sendMessage()">Send</button>
    </div>
    <button class="finbot-toggle" onclick="toggleFinbot()"><i class="fas fa-robot"></i></button>
    
    <div class="container mt-5">
        <h1 class="text-center mb-4 animate-fade-in text-primary"><i class="fas fa-chart-pie"></i> Profit Dashboard</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="diagrams-tab" data-bs-toggle="tab" data-bs-target="#diagrams" type="button" role="tab">Diagrams</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">Profit/Loss Data</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Diagrams Tab -->
            <div class="tab-pane fade show active" id="diagrams" role="tabpanel">
                <!-- Live Clock & Weather -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-clock text-info"></i> Live Clock</h5>
                                <p id="liveClock"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-cloud-sun text-warning"></i> Weather Widget</h5>
                                <p id="weather">Sunny, 25Â°C (Placeholder)</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Graphs -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5><i class="fas fa-chart-line text-primary"></i> Profit/Loss Trends</h5>
                            <button class="btn btn-sm btn-secondary mb-2" onclick="toggle3D(); playSound('3d')">Toggle 3D</button>
                            <canvas id="lineChart"></canvas>
                            <div id="threeContainer" style="display:none; height:300px;"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5><i class="fas fa-chart-bar text-success"></i> Profit/Loss by Period</h5>
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5><i class="fas fa-chart-pie text-warning"></i> Revenue vs. Cost</h5>
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <h5>Filters</h5>
                            <select id="filterSelect" class="form-select">
                                <option value="all">All Periods</option>
                            </select>
                            <button class="btn btn-outline-primary mt-2" onclick="applyFilter(); playSound('filter')">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Tab -->
            <div class="tab-pane fade" id="data" role="tabpanel">
                <!-- Badges and Fun Fact -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-trophy text-success"></i> Badges Earned</h5>
                                <ul id="badgesList" class="list-group"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-lightbulb text-warning"></i> Fun Fact</h5>
                                <p id="funFact"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="row mb-4" id="summaryRow">
                    <div class="col-md-3">
                        <div class="card p-3 text-white" style="background: linear-gradient(45deg, #28a745, #20c997);">
                            <div class="card-body">
                                <h5><i class="fas fa-dollar-sign"></i> Total Profit/Loss</h5>
                                <h3 id="totalProfit"></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-white" style="background: linear-gradient(45deg, #007bff, #6610f2);">
                            <div class="card-body">
                                <h5><i class="fas fa-chart-line"></i> Avg Profit/Loss</h5>
                                <h3 id="avgProfit"></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-white" style="background: linear-gradient(45deg, #ffc107, #fd7e14);">
                            <div class="card-body">
                                <h5><i class="fas fa-trending-up"></i> Avg Revenue</h5>
                                <h3 id="avgRevenue"></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 text-white" style="background: linear-gradient(45deg, #dc3545, #6f42c1);">
                            <div class="card-body">
                                <h5><i class="fas fa-trending-down"></i> Avg Cost</h5>
                                <h3 id="avgCost"></h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profit Journey Timeline -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-route text-info"></i> Profit Journey</h5>
                                <div id="timeline" class="timeline"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mastery Progress Bar -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-trophy text-success"></i> Profit Mastery Level</h5>
                                <div class="progress">
                                    <div class="progress-bar" id="masteryBar" style="width: 0%"></div>
                                </div>
                                <p id="masteryText"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Interactive Business Health Meter -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-gauge text-success"></i> Business Health Meter</h5>
                                <canvas id="healthMeter" width="300" height="150"></canvas>
                                <p id="healthStatus" class="mt-2 text-center"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Unique Features -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-gamepad text-success"></i> Profit Predictor Game</h5>
                                <p>Guess next period's profit: <input type="number" id="guessInput" class="form-control d-inline w-50"></p>
                                <button class="btn btn-primary" onclick="playGame(); playSound('game')">Submit Guess</button>
                                <p id="gameResult"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-volume-up text-info"></i> Voice Tips</h5>
                                <button class="btn btn-info" onclick="speakTips(); playSound('voice')">Narrate Tips</button>
                                <ul id="tipsList" class="list-group mt-2"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Story Mode -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-book-open text-secondary"></i> Data Story Mode</h5>
                                <button class="btn btn-info" onclick="tellStory(); playSound('story')">Narrate My Data Story</button>
                                <p id="storyText" class="mt-2"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profit Fortune Teller -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card p-3">
                            <div class="card-body">
                                <h5><i class="fas fa-crystal-ball text-primary"></i> Profit Fortune Teller</h5>
                                <button class="btn btn-warning" onclick="getFortune(); playSound('fortune')">Reveal Fortune</button>
                                <p id="fortuneText" class="mt-2 animate-fade-in"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="/export_csv" class="btn btn-primary" onclick="playSound('export')"><i class="fas fa-download"></i> Export Data</a>
            <button class="btn btn-secondary ms-2" onclick="shareResults(); playSound('share')">Share Results</button>
            <button class="btn btn-success ms-2" onclick="startDemo(); playSound('demo')">Start Demo Mode</button>
            <a href="/donate" class="btn btn-warning ms-2">Donate</a>
        </div>
    </div>
    
    <script>
        try {
            const chartData = JSON.parse(`{{ data | tojson | safe }}`);
            
            // Populate summary with Profit/Loss
            const totalProfit = chartData.summary.total_profit;
            document.getElementById('totalProfit').textContent = totalProfit >= 0 ? `Profit: $${totalProfit.toFixed(2)}` : `Loss: $${totalProfit.toFixed(2)}`;
            const avgProfit = chartData.summary.avg_profit;
            document.getElementById('avgProfit').textContent = avgProfit >= 0 ? `Profit: $${avgProfit.toFixed(2)}` : `Loss: $${avgProfit.toFixed(2)}`;
            document.getElementById('avgRevenue').textContent = '$' + chartData.summary.avg_revenue.toFixed(2);
            document.getElementById('avgCost').textContent = '$' + chartData.summary.avg_cost.toFixed(2);
            
            // Badges
            const badgesList = document.getElementById('badgesList');
            chartData.badges.forEach(badge => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = badge;
                badgesList.appendChild(li);
            });
            
            // Fun Fact
            document.getElementById('funFact').textContent = chartData.fun_facts;
            
                        // Mastery Bar
            document.getElementById('masteryBar').style.width = chartData.mastery_level + '%';
            document.getElementById('masteryText').textContent = `Level: ${chartData.mastery_level}%`;
            
            // Timeline
            const timeline = document.getElementById('timeline');
            chartData.periods.forEach((p, i) => {
                const profit = chartData.profits[i];
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `<strong>Period ${p}:</strong> ${profit >= 0 ? 'Profit' : 'Loss'} $${Math.abs(profit).toFixed(2)}`;
                timeline.appendChild(item);
            });
            
            // Tips
            const tipsList = document.getElementById('tipsList');
            chartData.tips.forEach(tip => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = tip;
                tipsList.appendChild(li);
            });
            
            // Populate filter options
            const filterSelect = document.getElementById('filterSelect');
            chartData.periods.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = `Period ${p}`;
                filterSelect.appendChild(option);
            });
            
            // Charts (handle negative values)
            let lineChart = new Chart(document.getElementById('lineChart'), {
                type: 'line',
                data: {
                    labels: chartData.periods.concat(chartData.future_periods),
                    datasets: [{
                        label: 'Profits/Losses',
                        data: chartData.profits.concat(chartData.future_profits),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        animation: { duration: 2000 }
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: false } } }
            });
            
            let barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: chartData.periods,
                    datasets: [{
                        label: 'Profits/Losses',
                        data: chartData.profits,
                        backgroundColor: chartData.profits.map(p => p >= 0 ? '#007bff' : '#dc3545'),
                        animation: { duration: 2000 }
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: false } } }
            });
            
            // Calculate profit and loss sums
            let totalProfitSum = 0;
            let totalLossSum = 0;
            chartData.profits.forEach(p => {
                if (p > 0) totalProfitSum += p;
                else totalLossSum += Math.abs(p);
            });
            
            new Chart(document.getElementById('pieChart'), {
                type: 'pie',
                data: {
                    labels: ['Revenue', 'Cost', 'Profit', 'Loss'],
                    datasets: [{
                        data: [
                            chartData.summary.avg_revenue * chartData.periods.length,
                            chartData.summary.avg_cost * chartData.periods.length,
                            totalProfitSum,
                            totalLossSum
                        ],
                        backgroundColor: ['#ffc107', '#dc3545', '#28a745', '#6c757d'],
                        animation: { duration: 2000 }
                    }]
                },
                options: { responsive: true }
            });
            
// FinBot Chat Assistant (Fixed for Dark Theme)
let userName = null;
let conversationStep = 0; // 0: Greeting, 1: Ask Name, 2: Questions

function sendMessage() {
    const input = document.getElementById('chatInput').value.trim().toLowerCase();
    const chatBox = document.getElementById('chatBox');
    const sidebar = document.getElementById('finbotSidebar');
    console.log('ChatBox Element:', chatBox);
    console.log('Sidebar Display:', sidebar.style.display);
    if (input === '') return;
    
    // Force sidebar open
    sidebar.style.display = 'flex';
    chatBox.style.display = 'block';
    
    // Detect theme and set colors
    const isDark = document.body.classList.contains('dark-theme');
    const textColor = isDark ? '#ffffff' : '#000000';  // White for dark, black for light
    const bgColor = isDark ? '#222222' : '#f8f9fa';    // Dark bg for dark, light for light
    chatBox.style.color = textColor;
    chatBox.style.background = bgColor;
    
    // User message
    const userMessage = `<p style="color: ${textColor};"><strong>You:</strong> ${input}</p>`;
    chatBox.innerHTML += userMessage;
    console.log('User Message Added:', userMessage);
    
    let response = "";
    
    if (conversationStep === 0) {
        if (input.includes('hi') || input.includes('hello') || input.includes('hey')) {
            response = "Hi there! I'm FinBot, your AI assistant for profit analysis. What's your name?";
            conversationStep = 1;
        } else {
            response = "Hello! Type 'hi' to start a conversation.";
        }
    } else if (conversationStep === 1) {
        userName = input.charAt(0).toUpperCase() + input.slice(1); // Capitalize name
        response = `Nice to meet you, ${userName}! Let's talk about your business. What's your current profit margin like? (e.g., low, good, or tell me a percentage)`;
        conversationStep = 2;
    } else if (conversationStep === 2) {
        // Handle questions and tips
        if (input.includes('profit margin') || input.includes('margin')) {
            if (input.includes('low') || (chartData.summary.avg_profit / chartData.summary.avg_revenue) * 100 < 10) {
                response = "Your profit margin is low due to high fixed costs. Reduce marketing spend by 8% to increase margin by 12%. Any other questions?";
            } else {
                response = "Your profit margin looks good! Keep optimizing costs. What about revenue?";
            }
        } else if (input.includes('revenue')) {
            response = "To boost revenue, focus on marketing and customer retention strategies. How are your costs?";
        } else if (input.includes('cost') || input.includes('costs')) {
            response = "High costs are impacting profits. Consider negotiating with suppliers or cutting unnecessary expenses. What about losses?";
        } else if (input.includes('loss') || input.includes('losses')) {
            if (chartData.summary.total_profit < 0) {
                response = "You're in a loss. Focus on reducing costs and increasing sales. Here's a tip: Diversify your product line.";
            } else {
                response = "Great, no losses! Here's an additional tip: Track expenses weekly to stay profitable.";
            }
        } else {
            response = "That's interesting! For more help, ask about 'profit margin', 'revenue', 'costs', or 'losses'. Or type 'reset' to start over.";
        }
        
        // Add random additional tip
        const tips = [
            "Tip: Automate repetitive tasks to save time and money.",
            "Tip: Use data analytics to predict trends.",
            "Tip: Build customer loyalty with personalized offers.",
            "Tip: Monitor cash flow regularly."
        ];
        response += " " + tips[Math.floor(Math.random() * tips.length)];
    }
    
    if (input === 'reset') {
        userName = null;
        conversationStep = 0;
        response = "Conversation reset. Type 'hi' to start again.";
    }
    
    const botMessage = `<p style="color: ${textColor};"><strong>FinBot:</strong> ${response}</p>`;
    chatBox.innerHTML += botMessage;
    console.log('Bot Message Added:', botMessage);
    console.log('ChatBox InnerHTML:', chatBox.innerHTML);
    chatBox.scrollTop = chatBox.scrollHeight;
    document.getElementById('chatInput').value = '';
}

            
            // Business Health Meter
            window.addEventListener('load', () => {
                console.log('Page loaded, drawing meter...');
                setTimeout(() => {
                    const healthScore = Math.min(100, Math.max(0, (chartData.summary.total_profit / 2000) * 100));
                    console.log('Health Score:', healthScore);
                    drawHealthMeter(healthScore);
                }, 2000);
            });
            
            function drawHealthMeter(score) {
                const canvas = document.getElementById('healthMeter');
                console.log('Drawing meter, canvas:', canvas);
                if (!canvas) {
                    console.error('Canvas not found! Check HTML.');
                    return;
                }
                const ctx = canvas.getContext('2d');
                const centerX = canvas.width / 2;
                const centerY = canvas.height - 20;
                const radius = 80;
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw gauge background
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, Math.PI, 0);
                ctx.lineWidth = 10;
                ctx.strokeStyle = '#e9ecef';
                ctx.stroke();
                
                // Draw colored arcs
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, Math.PI, Math.PI + (Math.PI / 3));
                ctx.strokeStyle = '#dc3545'; // Red for Bad
                ctx.stroke();
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, Math.PI + (Math.PI / 3), Math.PI + (2 * Math.PI / 3));
                ctx.strokeStyle = '#ffc107'; // Yellow for Average
                ctx.stroke();
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, Math.PI + (2 * Math.PI / 3), 0);
                ctx.strokeStyle = '#28a745'; // Green for Strong
                ctx.stroke();
                
                // Animate needle
                const maxAngle = Math.PI;
                const angle = Math.PI + (score / 100) * maxAngle;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + Math.cos(angle) * (radius - 20), centerY + Math.sin(angle) * (radius - 20));
                ctx.lineWidth = 5;
                ctx.strokeStyle = '#000';
                ctx.stroke();
                
                // Status text
                let status = 'Bad';
                if (score > 33) status = 'Average';
                if (score > 66) status = 'Strong';
                document.getElementById('healthStatus').textContent = `Health: ${status}`;
                console.log('Meter drawn with status:', status);
            }
            
            // Add manual redraw button
            document.addEventListener('DOMContentLoaded', () => {
                const meterCard = document.querySelector('#healthMeter').parentElement;
                if (meterCard) {
                    const redrawBtn = document.createElement('button');
                    redrawBtn.textContent = 'Redraw Meter';
                    redrawBtn.className = 'btn btn-sm btn-secondary mt-2';
                    redrawBtn.onclick = () => {
                        const healthScore = Math.min(100, Math.max(0, (chartData.summary.total_profit / 2000) * 100));
                        drawHealthMeter(healthScore);
                    };
                    meterCard.appendChild(redrawBtn);
                }
            });
            
            // Live Clock
            function updateClock() {
                const now = new Date();
                document.getElementById('liveClock').textContent = now.toLocaleTimeString();
            }
            setInterval(updateClock, 1000);
            updateClock();
            
            // Fortune Teller
            function getFortune() {
                fetch('/fortune_teller').then(res => res.json()).then(data => {
                    document.getElementById('fortuneText').textContent = data.fortune;
                    confetti();
                });
            }
            
            // Data Story
            function tellStory() {
                const story = `Once upon a time, your profits started at $${chartData.profits[0].toFixed(2)} and journeyed to $${chartData.profits[chartData.profits.length - 1].toFixed(2)}, facing challenges but emerging stronger!`;
                document.getElementById('storyText').textContent = story;
                const utterance = new SpeechSynthesisUtterance(story);
                window.speechSynthesis.speak(utterance);
            }
            
            // Game
            function playGame() {
                const guess = parseFloat(document.getElementById('guessInput').value);
                const actual = chartData.future_profits[0];
                fetch('/predict_score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ actual, guess })
                }).then(res => res.json()).then(data => {
                    document.getElementById('gameResult').textContent = `Your score: ${data.score}/100`;
                    if (data.score > 80) confetti();
                });
            }
            
            // Voice
            function speakTips() {
                const utterance = new SpeechSynthesisUtterance(chartData.tips.join('. '));
                window.speechSynthesis.speak(utterance);
            }
            
            // 3D Toggle
            function toggle3D() {
                if (typeof THREE === 'undefined') {
                    alert('Three.js not loaded. Please check your internet connection.');
                    return;
                }
                try {
                    const canvas = document.getElementById('lineChart');
                    const threeDiv = document.getElementById('threeContainer');
                    if (threeDiv.style.display === 'none') {
                        canvas.style.display = 'none';
                        threeDiv.style.display = 'block';
                        threeDiv.innerHTML = '';
                        
                        const scene = new THREE.Scene();
                        const camera = new THREE.PerspectiveCamera(75, 400 / 300, 0.1, 1000);
                        const renderer = new THREE.WebGLRenderer({ antialias: true });
                        renderer.setSize(400, 300);
                        renderer.setClearColor(0x000000, 1);
                        threeDiv.appendChild(renderer.domElement);
                        
                        const points = [];
                        for (let i = 0; i < chartData.periods.length; i++) {
                            points.push(new THREE.Vector3(chartData.periods[i] * 10, chartData.profits[i] * 10, 0));
                        }
                        const geometry = new THREE.BufferGeometry().setFromPoints(points);
                        const material = new THREE.LineBasicMaterial({ color: 0x28a745, linewidth: 2 });
                        const line = new THREE.Line(geometry, material);
                        scene.add(line);
                        
                        camera.position.z = 50;
                        
                        function animate() {
                            requestAnimationFrame(animate);
                            renderer.render(scene, camera);
                        }
                        animate();
                    } else {
                        canvas.style.display = 'block';
                        threeDiv.style.display = 'none';
                    }
                } catch (error) {
                    console.error('3D Error:', error);
                    alert('3D mode failed: ' + error.message);
                }
            }
            
            // Filter
            function applyFilter() {
                const filterValue = document.getElementById('filterSelect').value;
                if (filterValue === 'all') {
                    // Show all data
                    lineChart.data.labels = chartData.periods.concat(chartData.future_periods);
                    lineChart.data.datasets[0].data = chartData.profits.concat(chartData.future_profits);
                    barChart.data.labels = chartData.periods;
                    barChart.data.datasets[0].data = chartData.profits;
                } else {
                    // Show individual period
                    const periodIndex = parseInt(filterValue) - 1;
                    lineChart.data.labels = [chartData.periods[periodIndex]];
                    lineChart.data.datasets[0].data = [chartData.profits[periodIndex]];
                    barChart.data.labels = [chartData.periods[periodIndex]];
                    barChart.data.datasets[0].data = [chartData.profits[periodIndex]];
                }
                lineChart.update();
                barChart.update();
            }
            
            // Share
            function shareResults() {
                alert('Share link generated! (Placeholder)');
            }
            
            // Draggable cards
            Sortable.create(document.getElementById('summaryRow'), { animation: 150 });
            
            // Particle explosions on hover
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('mouseenter', () => {
                    confetti({ particleCount: 50, spread: 70, origin: { y: 0.6 } });
                });
            });
            
            // Auto-Demo Mode
            let demoInterval;
            function startDemo() {
                fetch('/demo_mode').then(res => res.json()).then(data => {
                    // Auto-fill and cycle (placeholder logic)
                    console.log('Demo started with data:', data);
                    demoInterval = setInterval(() => {
                        // Cycle features every 30s
                        console.log('Demo cycling...');
                    }, 30000);
                });
            }
            
            // Sound effects
            function playSound(type) {
                console.log('Playing sound:', type);
            }
            
            // Toggle FinBot
            function toggleFinbot() {
                const sidebar = document.getElementById('finbotSidebar');
                sidebar.style.display = sidebar.style.display === 'none' || sidebar.style.display === '' ? 'flex' : 'none';
            }
        } catch (error) {
            console.error('Error:', error);
            document.body.innerHTML += '<p class="text-danger">Error loading dashboard.</p>';
        }
    </script>
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>